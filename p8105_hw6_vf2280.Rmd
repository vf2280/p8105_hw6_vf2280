---
title: "Homework 6"
author: "Vasili Fokaidis"
output: html_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(modelr)
library(mgcv)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

Read in data.

## Problem 1

Read in the data.

```{r}
homicide_df = 
  read_csv("homicide_data/homicide-data.csv") %>%
  mutate(
    city_state = str_c(city, state, sep = ", "),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1
    )
  ) %>%
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa_AL") %>%
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

Start with one city.

```{r}
baltimore_df = 
  homicide_df %>%
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_race + victim_sex,
    data = baltimore_df,
    family = binomial()) %>%
  broom::tidy() %>%
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>%
  select(term, OR, starts_with("CI")) %>%
  knitr::kable(digits = 3)
```


Try this across cities. NOT WORKING WHYYYYYYYY!!!!!

```{r}
models_df =
homicide_df %>%
  nest(data = -city_state) %>%
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy())
  )
```


## Problem 2

Read in data.

```{r}
bth_wt = 
  read_csv("birthweight_data/birthweight.csv") %>%
  mutate(
    babysex = as.factor(babysex),
    mrace = as.factor(mrace),
    frace = as.factor(frace),
    bwt = bwt/453.592,
    frace = factor(frace, levels = c(1, 2, 3, 4, 8, 9), labels = c("white", "black", "asian", "puerto_rican", "other", "unknown")),
    mrace = factor(mrace, levels = c(1, 2, 3, 4, 8), labels = c("white", "black", "asian", "puerto_rican", "other"))
  )
  
```

To clean the data, I turned `babysex`, `frace`, and `mrace` into factors, I converted `bwt` from grams to pounds, and I converted `frace` and `mrace` values to the corresponding races.


Let's fit the model we care about (through backwards elimination)

```{r}
full_model = 
  lm(bwt ~ ., data = bth_wt)

step(full_model, direction = "backward", trace = TRUE)

full_model =
  step(full_model, direction = "backward", trace = FALSE) %>%
  broom::tidy()

full_model
```

Using backward elimination, the model was fitted using criterion based procedures (discrimination based on AIC values of various models). First, I developed a linear model containing all variables, then I ran the backward elimination with trace to evaluate the steps taken to deduce the final model. For example, the model without `wtgain` produced an AIC of -4403.92, and since this criterion based procedure aims for models with the lowest AIC, `wtgain` was removed, and so on. Finally, after many steps of this process, the model was produced.

Let's look at the result...

```{r}

```